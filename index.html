<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Card Rogue</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="fade"></div>
<h2 id="stageText">Stage 1</h2>

<div id="start">
    <h1>Card Rogue</h1>
    <button onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button>å›³é‘‘(æœªå®Ÿè£…)</button>
    <button onclick="alert('æ•µã‚’å€’ã—ã¦é€²ã‚€ã ã‘ã§ã™')">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</button>
</div>

<div id="shop" class="hidden">
    <h3>Coin: <span id="coinText"></span></h3>
    <div id="shopCards"></div>
    <button onclick="reroll()">æ›´æ–°(1ã‚³ã‚¤ãƒ³)</button>

    <h3>ãƒ‡ãƒƒã‚­ (æœ€å¤§5æš / ãƒ‰ãƒ©ãƒƒã‚°ã§å£²å´)</h3>
    <div id="deck"></div>

    <h3 style="color: #ff4444;">å£²å´ã‚¾ãƒ¼ãƒ³ (ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°)</h3>
    <div id="sellZone"></div>

    <button onclick="battle()" class="btn-battle">æˆ¦é—˜é–‹å§‹</button>
</div>

<div id="battle" class="hidden">
    <div id="log"></div>
    <div id="enemyArea"></div>
    <div id="allyArea" onclick="nextTurn()"></div>
</div>

<div id="clearScreen" class="hidden">
    <h1>GAME CLEAR</h1>
    <button onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<div id="gameOverScreen" class="hidden">
    <h1 class="text-danger">GAME OVER</h1>
    <button onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<script>
const baseChars=[
    {name:"ã‚¹ã‚¦",atk:250,hp:3000,rarity:3},
    {name:"ãƒ¬ã‚ªãƒŠ",atk:400,hp:4000,rarity:4},
    {name:"ã‚³ã‚¦",atk:500,hp:7000,rarity:5},
    {name:"ã‚­ãƒ§ã‚¦",atk:300,hp:1000,rarity:3},
    {name:"ã‚«ãƒ•",atk:400,hp:4000,rarity:4},
    {name:"ã‚¤ã‚°ãƒã‚¢",atk:300,hp:3000,rarity:3},
    {name:"ã‚¢ãƒ¬ã‚¯ã‚µãƒ³ãƒ€ãƒ¼",atk:999,hp:9999,rarity:5},
    {name:"ã‚¹ãƒ•ã‚§ãƒªã‚³ãƒ³",atk:400,hp:4000,rarity:4},
    {name:"èœœå¤œ",atk:400,hp:4000,rarity:4},
    {name:"ãƒ¡ãƒ“ã‚¦ã‚¹",atk:400,hp:4000,rarity:4},
    {name:"ãƒ­ãƒ¼ãƒãƒ³",atk:300,hp:3000,rarity:3},
    {name:"ã‚´ãƒ",atk:1,hp:3,rarity:3},
    {name:"ã‚³ã‚³ã­ã“",atk:999,hp:9999,rarity:5},
    {name:"ãœã‚‹ãœã‚‹ãƒ¤ãƒ‰ã‚«ãƒª",atk:436,hp:9999,rarity:4},
    {name:"ã´",atk999999:,hp:999999,rarity:5},
    {name:"ã­ã“ã«",atk:0,hp:1,rarity:3},
];

let stage=1, coin=6, deck=[], shop=[];
let enemy, turnIndex=0;
let battlePhase = "idle"; 
let actorIndex = 0; 

const startDiv=document.getElementById("start");
const shopDiv=document.getElementById("shop");
const battleDiv=document.getElementById("battle");
const clearScreen=document.getElementById("clearScreen");
const gameOverScreen=document.getElementById("gameOverScreen");
const shopCards=document.getElementById("shopCards");
const deckDiv=document.getElementById("deck");
const sellZone=document.getElementById("sellZone");
const coinText=document.getElementById("coinText");
const stageText=document.getElementById("stageText");
const enemyArea=document.getElementById("enemyArea");
const allyArea=document.getElementById("allyArea");
const logDiv=document.getElementById("log");

function log(t){ 
    logDiv.innerHTML += t+"<br>"; 
    logDiv.scrollTop = logDiv.scrollHeight;
}

function cost(r){return r==3?2:r==4?3:4;}
function copyChar(c){return {...c,rank:1,currentHp:c.hp,status:[]};}

function rarityPool(){
    if(stage<=3) return [3];
    if(stage<=6) return [3,4];
    return [3,3,4,4,5];
}

window.onload=()=>{
    hideAllScreens();
    startDiv.classList.remove("hidden");
};

function hideAllScreens() {
    [startDiv, shopDiv, battleDiv, clearScreen, gameOverScreen].forEach(div => {
        div.classList.add("hidden");
    });
}

function startGame(){
    stage=1; coin=6; deck=[];
    hideAllScreens();
    shopDiv.classList.remove("hidden");
    refreshShop();
}

function refreshShop(){
    stageText.innerText="Stage "+stage;
    coinText.innerText=coin;
    shop=[];
    let pool=rarityPool();
    for(let i=0;i<6;i++){
        let r=pool[Math.random()*pool.length|0];
        let list=baseChars.filter(c=>c.rarity==r);
        shop.push(copyChar(list[Math.random()*list.length|0]));
    }
    drawShop();
    drawDeck();
}

function drawShop(){
    shopCards.innerHTML="";
    shop.forEach((c,i)=>{
        let d=document.createElement("div");
        d.className=`card rarity-${c.rarity}`;
        d.draggable=true;
        d.innerHTML=`${c.name}<br>âš”ï¸${c.atk}<br>â™¥${c.hp}<br>${cost(c.rarity)}c`;
        d.ondragstart=e=>e.dataTransfer.setData("shopIndex",i);
        shopCards.appendChild(d);
    });
}

function drawDeck(){
    deckDiv.innerHTML="";
    deck.forEach((c,i)=>{
        let d=document.createElement("div");
        d.className=`card rarity-${c.rarity}`;
        d.draggable=true;
        let statusHtml = (c.status || []).map(s=>`${s.level}${getIcon(s.type)}${s.turn}`).join(" ");
        d.innerHTML=`${c.name}<br>âš”ï¸${calcAtk(c)}<br>â™¥${c.currentHp??c.hp}<br>${statusHtml}`;
        d.ondragstart=e=>e.dataTransfer.setData("deckIndex",i);
        deckDiv.appendChild(d);
    });
}

function getIcon(type){
    switch(type){
        case"æ¯’": return "â˜ ï¸";
        case"éº»ç—º": return "âš¡";
        case"æ‹˜æŸ": return "â›“ï¸";
        case"èˆˆå¥®": return "ğŸ’¥";
        default: return "?";
    }
}

deckDiv.ondragover=e=>e.preventDefault();
deckDiv.ondrop=e=>{
    let i=e.dataTransfer.getData("shopIndex");
    if(i==="" || i===undefined) return;
    buy(Number(i));
};

sellZone.ondragover=e=>e.preventDefault();
sellZone.ondrop=e=>{
    let i=e.dataTransfer.getData("deckIndex");
    if(i==="" || i===undefined) return;
    let c=deck[i];
    coin+=cost(c.rarity);
    deck.splice(i,1);
    coinText.innerText=coin;
    drawDeck();
};

function buy(i){
    let c=shop[i];
    let p=cost(c.rarity);
    if(coin<p) return;
    if(deck.length>=5) return;
    coin-=p;
    deck.push(copyChar(c));
    shop.splice(i,1);
    coinText.innerText=coin;
    drawShop();
    drawDeck();
}

function reroll(){
    if(coin<=0) return;
    coin--;
    refreshShop();
}

// --- ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ  ---

function battle(){
    if(deck.length==0) { alert("ãƒ‡ãƒƒã‚­ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ï¼"); return; }
    hideAllScreens();
    battleDiv.classList.remove("hidden");
    startBattle();
}

function startBattle(){
    logDiv.innerHTML = "";
    enemy={name:stage%5==0?"ãƒœã‚¹":"æ•µ", hp:stage%5==0?6000:2500, atk:600, status:[]};
    deck.forEach(c=>c.currentHp=c.hp);
    
    battlePhase = "ally"; 
    actorIndex = 0; 
    
    drawEnemy();
    drawAllies();
    log("æˆ¦é—˜é–‹å§‹ï¼ ç”»é¢ã‚¿ãƒƒãƒ—ã§é€²è¡Œã—ã¾ã™");
}

function nextTurn(){
    if (battlePhase === "end") {
        finishBattle();
        return;
    }
    if (battlePhase === "ally") {
        processAllyAction();
    } else if (battlePhase === "enemy") {
        processEnemyAction();
    }
}

function processAllyAction() {
    if (actorIndex >= deck.length) {
        battlePhase = "enemy";
        nextTurn(); 
        return;
    }

    let actor = deck[actorIndex];
    if (actor.currentHp <= 0) {
        actorIndex++;
        processAllyAction();
        return;
    }

    log(`--- ${actor.name} ã®è¡Œå‹• ---`);
    if (isStunned(actor)) {
        log(actor.name + " ã¯æ‹˜æŸã§å‹•ã‘ãªã„ï¼");
    } else {
        let atk = calcAtk(actor);
        enemy.hp -= atk;
        log(`${actor.name} ã®æ”»æ’ƒï¼ ${atk} ãƒ€ãƒ¡ãƒ¼ã‚¸`);
        
        // ã€è¿½åŠ ã€‘æ•µã‚’å€’ã—ãŸæ™‚ã®ãƒ­ã‚°
        if (enemy.hp <= 0) {
            enemy.hp = 0;
            log(`<b style='color:orange;'>${enemy.name} ã‚’å€’ã—ãŸï¼</b>`);
        }
    }

    drawEnemy();
    actorIndex++;
    checkBattleEnd();
}

function processEnemyAction() {
    log(`--- ${enemy.name} ã®è¡Œå‹• ---`);
    let aliveTargets = deck.filter(c => c.currentHp > 0);
    
    if (aliveTargets.length > 0) {
        let target = aliveTargets[Math.floor(Math.random() * aliveTargets.length)];
        let atk = calcAtk(enemy);
        target.currentHp -= atk;
        log(`${enemy.name} ã®æ”»æ’ƒï¼ ${target.name} ã« ${atk} ãƒ€ãƒ¡ãƒ¼ã‚¸`);

        // ã€è¿½åŠ ã€‘æˆ¦é—˜ä¸èƒ½åˆ¤å®š
        if (target.currentHp <= 0) {
            target.currentHp = 0; // ãƒã‚¤ãƒŠã‚¹ã«ãªã‚‰ãªã„ã‚ˆã†ã«è£œæ­£
            log(`<b style='color:red;'>${target.name} ãŒæˆ¦é—˜ä¸èƒ½ã«ãªã£ãŸï¼</b>`);
        }
    }

    applyStatus(enemy);
    deck.forEach(c => applyStatus(c));
    drawAllies();
    drawEnemy();

    battlePhase = "ally";
    actorIndex = 0;
    checkBattleEnd();
}
    
function checkBattleEnd() {
    if (enemy.hp <= 0) {
        log("<b style='color:yellow;'>å‹åˆ©ï¼ ç”»é¢ã‚¿ãƒƒãƒ—ã§æ¬¡ã¸</b>");
        battlePhase = "end";
        deck.forEach(c => { c.currentHp = c.hp; c.status = []; });
    } else if (deck.every(c => c.currentHp <= 0)) {
        log("<b style='color:red;'>æ•—åŒ—... ç”»é¢ã‚¿ãƒƒãƒ—ã§çµ‚äº†</b>");
        battlePhase = "end";
    }
}

function finishBattle() {
    if (enemy.hp <= 0) {
        let reward = 5;
        coin += reward;
        stage++;
        if (stage > 10) {
            hideAllScreens();
            clearScreen.classList.remove("hidden");
        } else {
            hideAllScreens();
            shopDiv.classList.remove("hidden");
            refreshShop();
        }
    } else {
        loseBattle();
    }
}

function calcAtk(unit){
    let atk = unit.atk;
    if(unit.status){
        unit.status.forEach(s=>{
            if(s.type==="éº»ç—º") atk -= s.level*30;
            if(s.type==="èˆˆå¥®") atk += s.level*30;
        });
    }
    return Math.max(0, atk);
}

function drawEnemy(){
    if(!enemy) return;
    let statusHtml = enemy.status.map(s=>`${s.level}${getIcon(s.type)}${s.turn}`).join(" ");
    enemyArea.innerHTML = `<div class="card rarity-4">${enemy.name}<br>âš”ï¸${calcAtk(enemy)}<br>â™¥${enemy.hp}<br>${statusHtml}</div>`;
}

function drawAllies(){
    allyArea.innerHTML="";
    deck.forEach(c=>{
        if(c.currentHp<=0) return;
        let statusHtml = c.status.map(s=>`${s.level}${getIcon(s.type)}${s.turn}`).join(" ");
        allyArea.innerHTML += `<div class="card rarity-${c.rarity}">${c.name}<br>âš”ï¸${calcAtk(c)}<br>â™¥${c.currentHp}<br>${statusHtml}</div>`;
    });
}

function isStunned(c){ return c.status && c.status.some(s=>s.type==="æ‹˜æŸ"); }

function applyStatus(unit){
    if(!unit || !unit.status) return;
    let remove=[];
    unit.status.forEach((s,i)=>{
        if(s.type==="æ¯’"){
            unit.currentHp -= s.level*100;
            log(unit.name+" ã¯æ¯’ã§ "+(s.level*100)+" ãƒ€ãƒ¡ãƒ¼ã‚¸");
        }
        s.turn--;
        if(s.turn<=0) remove.push(i);
    });
    remove.reverse().forEach(i=>unit.status.splice(i,1));
}

function loseBattle(){
    hideAllScreens();
    gameOverScreen.classList.remove("hidden");
}

function backToTitle(){
    stage = 1; coin = 6; enemy = null; turnIndex = 0; deck = []; shop = [];
    hideAllScreens();
    startDiv.classList.remove("hidden");
    logDiv.innerHTML="";
    coinText.innerText = coin;
    stageText.innerText = "Stage "+stage;
    drawDeck();
    shopCards.innerHTML="";
}
</script>
</body>
</html>
