<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Card Rogue</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div id="fade"></div>
<h2 id="stageText">Stage 1</h2>

<div id="start">
<button onclick="startGame()">スタート</button>
<button>図鑑(未実装)</button>
<button onclick="alert('敵を倒して進むだけです')">チュートリアル</button>
</div>

<div id="shop" class="hidden">
<h3>Coin: <span id="coinText"></span></h3>
<div id="shopCards"></div>
<button onclick="reroll()">更新(1コイン)</button>

<h3>デッキ</h3>
<div id="deck"></div>

<h3>売却ゾーン</h3>
<div id="sellZone"></div>

<button onclick="battle()">戦闘開始</button>
</div>

<!-- 戦闘 -->
<div id="battle" class="hidden">
<div id="log"></div>
<div id="enemyArea"></div>
<div id="allyArea" onclick="nextTurn()"></div>
</div>

<div id="clearScreen" class="hidden">
<h1>GAME CLEAR</h1>
<button onclick="backToTitle()">タイトルへ戻る</button>
</div>

<div id="gameOverScreen" class="hidden">
<h1>GAME OVER</h1>
<button onclick="backToTitle()">タイトルへ戻る</button>
</div>

<script>
const baseChars=[
{name:"スウ",atk:300,hp:3000,rarity:3},
{name:"レオナ",atk:400,hp:4000,rarity:4},
{name:"コウ",atk:500,hp:7000,rarity:5},
{name:"キョウ",atk:300,hp:1000,rarity:3},
{name:"カフ",atk:400,hp:4000,rarity:4},
{name:"イグノア",atk:300,hp:3000,rarity:3},
{name:"アレクサンダー",atk:999,hp:9999,rarity:5},
{name:"スフェリコン",atk:400,hp:4000,rarity:4},
{name:"蜜夜",atk:400,hp:4000,rarity:4},
{name:"メビウス",atk:400,hp:4000,rarity:4},
{name:"ローマン",atk:300,hp:3000,rarity:3},
{name:"ゴマ",atk:1,hp:3,rarity:3},
{name:"ココねこ",atk:999,hp:9999,rarity:5},
{name:"ぜるぜるヤドカリ",atk:436,hp:9999,rarity:4},
];

let stage=1,coin=6,deck=[],shop=[];
let enemy,turnIndex=0;

const startDiv=document.getElementById("start");
const shopDiv=document.getElementById("shop");
const battleDiv=document.getElementById("battle");
const clearScreen=document.getElementById("clearScreen");
const gameOverScreen=document.getElementById("gameOverScreen");

const shopCards=document.getElementById("shopCards");
const deckDiv=document.getElementById("deck");
const sellZone=document.getElementById("sellZone");
const coinText=document.getElementById("coinText");
const stageText=document.getElementById("stageText");
const enemyArea=document.getElementById("enemyArea");
const allyArea=document.getElementById("allyArea");
const logDiv=document.getElementById("log");

function log(t){ logDiv.innerHTML=t; }

function cost(r){return r==3?2:r==4?3:4;}
function copyChar(c){return {...c,rank:1,currentHp:c.hp};}

function rarityPool(){
 if(stage<=3) return [3];
 if(stage<=6) return [3,4];
 return [3,3,4,4,5];
}

window.onload=()=>{
 startDiv.classList.remove("hidden");
};

function startGame(){
 stage=1;coin=6;deck=[];
 startDiv.classList.add("hidden");
 shopDiv.classList.remove("hidden");
 refreshShop();
}

function refreshShop(){
 stageText.innerText="Stage "+stage;
 coinText.innerText=coin;

 shop=[];
 let pool=rarityPool();

 for(let i=0;i<6;i++){
  let r=pool[Math.random()*pool.length|0];
  let list=baseChars.filter(c=>c.rarity==r);
  shop.push(copyChar(list[Math.random()*list.length|0]));
 }
 drawShop();
 drawDeck();
}

//////////////////////////
// ▼ ドラッグショップ
//////////////////////////

function drawShop(){
 shopCards.innerHTML="";
 shop.forEach((c,i)=>{
  let d=document.createElement("div");
  d.className="card";
  d.draggable=true;

  d.innerHTML=
  `${c.name}<br>⚔️${c.atk}<br>♥${c.hp}<br>${cost(c.rarity)}c`;

  d.ondragstart=e=>{
   e.dataTransfer.setData("shopIndex",i);
  };

  shopCards.appendChild(d);
 });
}

//////////////////////////
// ▼ ドラッグデッキ
//////////////////////////

function drawDeck(){
 deckDiv.innerHTML="";
 deck.forEach((c,i)=>{
  let d=document.createElement("div");
  d.className="card";
  d.draggable=true;

  d.innerHTML=
  `${c.name}<br>⚔️${c.atk}<br>♥${c.currentHp??c.hp}`;

  d.ondragstart=e=>{
   e.dataTransfer.setData("deckIndex",i);
  };

  deckDiv.appendChild(d);
 });
}

// ショップ→デッキ
deckDiv.ondragover=e=>e.preventDefault();
deckDiv.ondrop=e=>{
 let i=e.dataTransfer.getData("shopIndex");
 if(i==="") return;
 buy(Number(i));
};

// デッキ→売却
sellZone.ondragover=e=>e.preventDefault();
sellZone.ondrop=e=>{
 let i=e.dataTransfer.getData("deckIndex");
 if(i==="") return;

 let c=deck[i];
 coin+=cost(c.rarity);
 deck.splice(i,1);

 coinText.innerText=coin;
 drawDeck();
};

function buy(i){
 let c=shop[i];
 let p=cost(c.rarity);

 if(coin<p) return;
 if(deck.length>=5) return;

 coin-=p;
 deck.push(copyChar(c));
 shop.splice(i,1);

 coinText.innerText=coin;
 drawShop();
 drawDeck();
}

function reroll(){
 if(coin<=0) return;
 coin--;
 refreshShop();
}

//////////////////////////
// ▼ 戦闘
//////////////////////////

function battle(){
 if(deck.length==0) return;

 shopDiv.classList.add("hidden");
 battleDiv.classList.remove("hidden");
 startBattle();
}

function startBattle(){
 turnIndex=0;
 enemy={name:stage%5==0?"ボス":"敵",hp:stage%5==0?6000:2500,atk:600};

 deck.forEach(c=>c.currentHp=c.hp);

 drawEnemy();
 drawAllies();
 log("戦闘開始 画面タップで進行");
}

function drawEnemy(){
 enemyArea.innerHTML=
 `<div class="card">
 ${enemy.name}<br>
 ⚔️${enemy.atk}<br>
 ♥${enemy.hp}
 </div>`;
}

function drawAllies(){
 allyArea.innerHTML="";
 deck.forEach(c=>{
  if(c.currentHp<=0) return;
  allyArea.innerHTML+=
  `<div class="card">
   ${c.name}<br>
   ♥${c.currentHp}
  </div>`;
 });
}

function nextTurn(){

 if(enemy.hp<=0) return;

 let actor=deck[turnIndex%deck.length];
 if(!actor||actor.currentHp<=0){
  turnIndex++;return;
 }

 enemy.hp-=actor.atk;
 log(actor.name+" のこうげき！");
 drawEnemy();

 if(enemy.hp<=0){ winBattle(); return; }

 let target=deck.find(c=>c.currentHp>0);
 if(target){
  target.currentHp-=enemy.atk;
  if(target.currentHp<=0){
   log(target.name+" が倒れた！");
  }
 }

 if(deck.every(c=>c.currentHp<=0)){
  loseBattle();return;
 }

 drawAllies();
 turnIndex++;
}

function winBattle(){
 let reward=5;
 coin+=reward;
 stage++;

 if(stage>10){
  battleDiv.classList.add("hidden");
  clearScreen.classList.remove("hidden");
  return;
 }

 log("勝利 +"+reward+"コイン");
 setTimeout(()=>{
  battleDiv.classList.add("hidden");
  shopDiv.classList.remove("hidden");
  refreshShop();
 },1000);
}

function loseBattle(){
 battleDiv.classList.add("hidden");
 gameOverScreen.classList.remove("hidden");
}

function backToTitle(){
 location.reload();
}
</script>
</body>
</html>
