<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Card Roguelike</title>

<style>
body{
 font-family:sans-serif;
 background:#222;
 color:white;
 text-align:center;
}

#shop,#deck,#sellZone{
 border:2px solid white;
 padding:10px;
 margin:10px;
 min-height:120px;
}

.card{
 display:inline-block;
 border:1px solid white;
 padding:8px;
 margin:5px;
 background:#333;
 cursor:pointer;
 touch-action:none;
}

#sellZone{
 background:#400;
}
</style>
</head>

<body>

<h2>コイン: <span id="coin">10</span></h2>
<h3>ステージ: <span id="stage">1</span></h3>

<div id="shop"><h3>ショップ</h3></div>
<div id="deck"><h3>デッキ(最大5)</h3></div>
<div id="sellZone"><h3>売却ゾーン</h3></div>

<button onclick="battle()">戦闘</button>

<script>
let coin=10;
let stage=1;
let deck=[];
let shop=[];

const rarities=["N","R","SR"];

function cost(r){
 return {N:3,R:5,SR:8}[r];
}

function randomCard(){
 let r=rarities[Math.floor(Math.random()*3)];
 return {rarity:r,power:{N:5,R:10,SR:18}[r]};
}

function drawShop(){
 shopDiv.innerHTML="<h3>ショップ</h3>";
 shop=[];
 for(let i=0;i<3;i++){
  let c=randomCard();
  shop.push(c);

  let d=document.createElement("div");
  d.className="card";
  d.textContent=`${c.rarity} 攻:${c.power} (${cost(c.rarity)}C)`;

  enableDrag(d,{type:"shop",index:i});
  shopDiv.appendChild(d);
 }
}

function drawDeck(){
 deckDiv.innerHTML="<h3>デッキ(最大5)</h3>";
 deck.forEach((c,i)=>{
  let d=document.createElement("div");
  d.className="card";
  d.textContent=`${c.rarity} 攻:${c.power}`;
  enableDrag(d,{type:"deck",index:i});
  deckDiv.appendChild(d);
 });
}

function refresh(){
 coinSpan.textContent=coin;
 stageSpan.textContent=stage;
 drawShop();
 drawDeck();
}

function battle(){
 if(deck.length===0){
  alert("カードなし");
  return;
 }

 let total=deck.reduce((a,c)=>a+c.power,0);
 let enemy=2000;

 if(total>=enemy){
  alert("勝利");

  if(stage<=3) coin+=4;
  else if(stage<=7) coin+=6;
  else coin+=9;

  stage++;

  if(stage>10){
   alert("ゲームクリア！");
   stage=1;
   coin=10;
   deck=[];
  }
 }else{
  alert("敗北…ゲームオーバー");
  stage=1;
  coin=10;
  deck=[];
 }

 refresh();
}

/* --- ドラッグ処理 --- */

function enableDrag(el,data){
 el.onpointerdown=e=>{
  e.preventDefault();

  let clone=el.cloneNode(true);
  clone.style.position="fixed";
  clone.style.zIndex=1000;
  clone.style.opacity=0.7;
  document.body.appendChild(clone);

  move(e);

  function move(ev){
   clone.style.left=ev.clientX-40+"px";
   clone.style.top=ev.clientY-40+"px";
  }

  function up(ev){
   document.removeEventListener("pointermove",move);
   document.removeEventListener("pointerup",up);

   let drop=document.elementFromPoint(ev.clientX,ev.clientY);

   if(data.type==="shop" && drop.closest("#deck")){
    buy(data.index);
   }

   if(data.type==="deck" && drop.closest("#sellZone")){
    sell(data.index);
   }

   clone.remove();
  }

  document.addEventListener("pointermove",move);
  document.addEventListener("pointerup",up);
 };
}

function buy(i){
 if(deck.length>=5) return;

 let c=shop[i];
 let price=cost(c.rarity);

 if(coin<price) return;

 coin-=price;
 deck.push(c);
 refresh();
}

function sell(i){
 let c=deck[i];
 let price=cost(c.rarity);

 coin+=price;
 deck.splice(i,1);
 refresh();
}

/* --- 初期化 --- */

let shopDiv=document.getElementById("shop");
let deckDiv=document.getElementById("deck");
let coinSpan=document.getElementById("coin");
let stageSpan=document.getElementById("stage");

refresh();
</script>

</body>
</html>
