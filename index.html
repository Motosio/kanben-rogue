<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Card Rogue</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="fade"></div>
<h2 id="stageText">Stage 1</h2>

<div id="start">
    <h1>Card Rogue</h1>
    <button onclick="startGame()">スタート</button>
    <button>図鑑(未実装)</button>
    <button onclick="alert('敵を倒して進むだけです')">チュートリアル</button>
</div>

<div id="shop" class="hidden">
    <h3>Coin: <span id="coinText"></span></h3>
    <div id="shopCards"></div>
    <button onclick="reroll()">更新(1コイン)</button>

    <h3>デッキ (最大5枚 / ドラッグで売却)</h3>
    <div id="deck"></div>

    <h3 style="color: #ff4444;">売却ゾーン (ここにドラッグ)</h3>
    <div id="sellZone"></div>

    <button onclick="battle()" class="btn-battle">戦闘開始</button>
</div>

<div id="battle" class="hidden">
    <div id="log"></div>
    <div id="enemyArea"></div>
    <div id="allyArea" onclick="nextTurn()"></div>
</div>

<div id="clearScreen" class="hidden">
    <h1>GAME CLEAR</h1>
    <button onclick="backToTitle()">タイトルへ戻る</button>
</div>

<div id="gameOverScreen" class="hidden">
    <h1 class="text-danger">GAME OVER</h1>
    <button onclick="backToTitle()">タイトルへ戻る</button>
</div>

// 追加する変数
let battlePhase = "idle"; // "ally", "enemy", "end"
let actorIndex = 0; // 今攻撃している味方の番号

function startBattle(){
    logDiv.innerHTML = "";
    enemy = {name:stage%5==0?"ボス":"敵", hp:stage%5==0?6000:2500, maxHp:stage%5==0?6000:2500, atk:600, status:[]};
    deck.forEach(c => {
        c.currentHp = c.hp;
        c.status = [];
    });
    
    battlePhase = "ally"; // 最初は味方のターン
    actorIndex = 0;
    
    drawEnemy();
    drawAllies();
    log("戦闘開始！ 画面タップで進行します");
}

// 画面クリックで呼ばれる関数を改造
function nextTurn(){
    if (battlePhase === "end") {
        // 戦闘終了後のクリック処理
        finishBattle();
        return;
    }

    if (battlePhase === "ally") {
        processAllyAction();
    } else if (battlePhase === "enemy") {
        processEnemyAction();
    }
}

// 味方一人の行動処理
function processAllyAction() {
    // 全員行動し終えたら敵の番へ
    if (actorIndex >= deck.length) {
        battlePhase = "enemy";
        nextTurn(); // 自動で敵の処理へ
        return;
    }

    let actor = deck[actorIndex];

    // 死んでいる場合はスキップして次へ
    if (actor.currentHp <= 0) {
        actorIndex++;
        processAllyAction();
        return;
    }

    log(`--- ${actor.name} の行動 ---`);
    if (isStunned(actor)) {
        log(actor.name + " は拘束で動けない！");
    } else {
        let atk = calcAtk(actor);
        enemy.hp -= atk;
        log(`${actor.name} の攻撃！ ${atk} ダメージ`);
    }

    drawEnemy();
    actorIndex++;

    // 敵が死んだかチェック
    if (enemy.hp <= 0) {
        checkBattleEnd();
    }
}

// 敵の行動処理
function processEnemyAction() {
    log(`--- ${enemy.name} の行動 ---`);
    
    let aliveTargets = deck.filter(c => c.currentHp > 0);
    if (aliveTargets.length > 0) {
        let target = aliveTargets[Math.floor(Math.random() * aliveTargets.length)];
        let atk = calcAtk(enemy);
        target.currentHp -= atk;
        log(`${enemy.name} の攻撃！ ${target.name} に ${atk} ダメージ`);
    }

    // 状態異常の処理
    applyStatus(enemy);
    deck.forEach(c => applyStatus(c));

    drawAllies();
    drawEnemy();

    // 次のターンの準備
    battlePhase = "ally";
    actorIndex = 0;

    checkBattleEnd();
}

// 決着がついたかチェック
function checkBattleEnd() {
    if (enemy.hp <= 0) {
        log("<b style='color:yellow;'>勝利！ 画面タップで次へ</b>");
        battlePhase = "end";
        // 勝利時の全回復
        deck.forEach(c => {
            c.currentHp = c.hp;
            c.status = [];
        });
    } else if (deck.every(c => c.currentHp <= 0)) {
        log("<b style='color:red;'>敗北... 画面タップで終了</b>");
        battlePhase = "end";
    }
}

// 終了後の実際の切り替え
function finishBattle() {
    if (enemy.hp <= 0) {
        let reward = 5;
        coin += reward;
        stage++;
        if (stage > 10) {
            hideAllScreens();
            clearScreen.classList.remove("hidden");
        } else {
            hideAllScreens();
            shopDiv.classList.remove("hidden");
            refreshShop();
        }
    } else {
        loseBattle();
    }
}

// 以下の関数は変更なしでOK
function isStunned(c){ return c.status && c.status.some(s=>s.type==="拘束"); }
function applyStatus(unit){
    if(!unit || !unit.status) return;
    let remove=[];
    unit.status.forEach((s,i)=>{
        if(s.type==="毒"){
            unit.currentHp -= s.level*100;
            log(unit.name+" は毒で "+(s.level*100)+" ダメージ");
        }
        s.turn--;
        if(s.turn<=0) remove.push(i);
    });
    remove.reverse().forEach(i=>unit.status.splice(i,1));
}
// ... calcAtk, drawEnemy, drawAllies, loseBattle 等もそのまま ...
</body>
</html>
