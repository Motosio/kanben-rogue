<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Card Rogue</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div id="fade"></div>
<h2 id="stageText">Stage 1</h2>

<div id="start">
<button onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
<button>å›³é‘‘(æœªå®Ÿè£…)</button>
<button onclick="alert('æ•µã‚’å€’ã—ã¦é€²ã‚€ã ã‘ã§ã™')">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</button>
</div>

<div id="shop" class="hidden">
<h3>Coin: <span id="coinText"></span></h3>
<div id="shopCards"></div>
<button onclick="reroll()">æ›´æ–°(1ã‚³ã‚¤ãƒ³)</button>

<h3>ãƒ‡ãƒƒã‚­</h3>
<div id="deck"></div>

<h3>å£²å´ã‚¾ãƒ¼ãƒ³</h3>
<div id="sellZone"></div>

<button onclick="battle()">æˆ¦é—˜é–‹å§‹</button>
</div>

<!-- æˆ¦é—˜ -->
<div id="battle" class="hidden">
<div id="log"></div>
<div id="enemyArea"></div>
<div id="allyArea" onclick="nextTurn()"></div>
</div>

<div id="clearScreen" class="hidden">
<h1>GAME CLEAR</h1>
<button onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<div id="gameOverScreen" class="hidden">
<h1>GAME OVER</h1>
<button onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<script>
const baseChars=[
{name:"ã‚¹ã‚¦",atk:300,hp:3000,rarity:3},
{name:"ãƒ¬ã‚ªãƒŠ",atk:400,hp:4000,rarity:4},
{name:"ã‚³ã‚¦",atk:500,hp:7000,rarity:5},
{name:"ã‚­ãƒ§ã‚¦",atk:300,hp:1000,rarity:3},
{name:"ã‚«ãƒ•",atk:400,hp:4000,rarity:4},
{name:"ã‚¤ã‚°ãƒã‚¢",atk:300,hp:3000,rarity:3},
{name:"ã‚¢ãƒ¬ã‚¯ã‚µãƒ³ãƒ€ãƒ¼",atk:999,hp:9999,rarity:5},
{name:"ã‚¹ãƒ•ã‚§ãƒªã‚³ãƒ³",atk:400,hp:4000,rarity:4},
{name:"èœœå¤œ",atk:400,hp:4000,rarity:4},
{name:"ãƒ¡ãƒ“ã‚¦ã‚¹",atk:400,hp:4000,rarity:4},
{name:"ãƒ­ãƒ¼ãƒãƒ³",atk:300,hp:3000,rarity:3},
{name:"ã‚´ãƒ",atk:1,hp:3,rarity:3},
{name:"ã‚³ã‚³ã­ã“",atk:999,hp:9999,rarity:5},
{name:"ãœã‚‹ãœã‚‹ãƒ¤ãƒ‰ã‚«ãƒª",atk:436,hp:9999,rarity:4},
];

let stage=1,coin=6,deck=[],shop=[];
let enemy,turnIndex=0;

const startDiv=document.getElementById("start");
const shopDiv=document.getElementById("shop");
const battleDiv=document.getElementById("battle");
const clearScreen=document.getElementById("clearScreen");
const gameOverScreen=document.getElementById("gameOverScreen");

const shopCards=document.getElementById("shopCards");
const deckDiv=document.getElementById("deck");
const sellZone=document.getElementById("sellZone");
const coinText=document.getElementById("coinText");
const stageText=document.getElementById("stageText");
const enemyArea=document.getElementById("enemyArea");
const allyArea=document.getElementById("allyArea");
const logDiv=document.getElementById("log");

function log(t){ logDiv.innerHTML += t+"<br>"; }

function cost(r){return r==3?2:r==4?3:4;}
function copyChar(c){return {...c,rank:1,currentHp:c.hp,status:[]};}

function rarityPool(){
 if(stage<=3) return [3];
 if(stage<=6) return [3,4];
 return [3,3,4,4,5];
}

window.onload=()=>{
 startDiv.classList.remove("hidden");
};

function startGame(){
 stage=1;coin=6;deck=[];
 startDiv.classList.add("hidden");
 shopDiv.classList.remove("hidden");
 refreshShop();
}

function refreshShop(){
 stageText.innerText="Stage "+stage;
 coinText.innerText=coin;
 shop=[];
 let pool=rarityPool();
 for(let i=0;i<6;i++){
  let r=pool[Math.random()*pool.length|0];
  let list=baseChars.filter(c=>c.rarity==r);
  shop.push(copyChar(list[Math.random()*list.length|0]));
 }
 drawShop();
 drawDeck();
}

//////////////////////////
// ãƒ‰ãƒ©ãƒƒã‚°
//////////////////////////
function drawShop(){
 shopCards.innerHTML="";
 shop.forEach((c,i)=>{
  let d=document.createElement("div");
  d.className="card";
  d.draggable=true;
  d.innerHTML=`${c.name}<br>âš”ï¸${c.atk}<br>â™¥${c.hp}<br>${cost(c.rarity)}c`;
  d.ondragstart=e=>e.dataTransfer.setData("shopIndex",i);
  shopCards.appendChild(d);
 });
}

function drawDeck(){
 deckDiv.innerHTML="";
 deck.forEach((c,i)=>{
  let d=document.createElement("div");
  d.className="card";
  let statusHtml=c.status.map(s=>`${s.level}${getIcon(s.type)}${s.turn}`).join(" ");
  d.innerHTML=`${c.name}<br>âš”ï¸${c.atk}<br>â™¥${c.currentHp??c.hp}<br>${statusHtml}`;
  d.ondragstart=e=>e.dataTransfer.setData("deckIndex",i);
  deckDiv.appendChild(d);
 });
}

function getIcon(type){
 switch(type){
  case"æ¯’": return "â˜ ï¸";
  case"éº»ç—º": return "âš¡";
  case"æ‹˜æŸ": return "â›“ï¸";
  case"èˆˆå¥®": return "ğŸ’¥";
  default: return "?";
 }
}

deckDiv.ondragover=e=>e.preventDefault();
deckDiv.ondrop=e=>{
 let i=e.dataTransfer.getData("shopIndex");
 if(i==="") return;
 buy(Number(i));
};

sellZone.ondragover=e=>e.preventDefault();
sellZone.ondrop=e=>{
 let i=e.dataTransfer.getData("deckIndex");
 if(i==="") return;
 let c=deck[i];
 coin+=cost(c.rarity);
 deck.splice(i,1);
 coinText.innerText=coin;
 drawDeck();
};

function buy(i){
 let c=shop[i];
 let p=cost(c.rarity);
 if(coin<p) return;
 if(deck.length>=5) return;
 coin-=p;
 deck.push(copyChar(c));
 shop.splice(i,1);
 coinText.innerText=coin;
 drawShop();
 drawDeck();
}

function reroll(){
 if(coin<=0) return;
 coin--;
 refreshShop();
}

//////////////////////////
// æˆ¦é—˜
//////////////////////////

function battle(){
 if(deck.length==0) return;
 shopDiv.classList.add("hidden");
 battleDiv.classList.remove("hidden");
 startBattle();
}

function startBattle(){
 turnIndex=0;
 enemy={name:stage%5==0?"ãƒœã‚¹":"æ•µ",hp:stage%5==0?6000:2500,atk:600,status:[]};
 deck.forEach(c=>c.currentHp=c.hp);
 drawEnemy();
 drawAllies();
 log("æˆ¦é—˜é–‹å§‹ ç”»é¢ã‚¿ãƒƒãƒ—ã§é€²è¡Œ");
}

function drawEnemy(){
 let statusHtml=enemy.status.map(s=>`${s.level}${getIcon(s.type)}${s.turn}`).join(" ");
 enemyArea.innerHTML=
 `<div class="card">${enemy.name}<br>âš”ï¸${enemy.atk}<br>â™¥${enemy.hp}<br>${statusHtml}</div>`;
}

function drawAllies(){
 allyArea.innerHTML="";
 deck.forEach(c=>{
  if(c.currentHp<=0) return;
  let statusHtml=c.status.map(s=>`${s.level}${getIcon(s.type)}${s.turn}`).join(" ");
  allyArea.innerHTML+=`<div class="card">${c.name}<br>â™¥${c.currentHp}<br>${statusHtml}</div>`;
 });
}

// 1ã‚¿ãƒ¼ãƒ³ï¼šå‘³æ–¹å…¨å“¡æ”»æ’ƒâ†’æ•µåæ’ƒâ†’çŠ¶æ…‹ç•°å¸¸å‡¦ç†
function nextTurn(){
 if(enemy.hp<=0) return;

 log("=== ã‚¿ãƒ¼ãƒ³é–‹å§‹ ===");

 // å‘³æ–¹å…¨å“¡æ”»æ’ƒ
 deck.forEach(actor=>{
  if(actor.currentHp<=0) return;

  if(isStunned(actor)){ 
    log(actor.name+" ã¯æ‹˜æŸã§å‹•ã‘ãªã„ï¼");
    return;
  }

  let atk=actor.atk;
  actor.status.forEach(s=>{
    if(s.type==="éº»ç—º") atk -= s.level*30;
    if(s.type==="èˆˆå¥®") atk += s.level*30;
  });
  atk=Math.max(0,atk);
  enemy.hp-=atk;
  log(actor.name+" ã®ã“ã†ã’ãï¼ "+atk+" ãƒ€ãƒ¡ãƒ¼ã‚¸");
});

drawEnemy();
if(enemy.hp<=0){ winBattle(); return; }

// æ•µã®æ”»æ’ƒ
let target=deck.find(c=>c.currentHp>0);
if(target){
  let atk=enemy.atk;
  enemy.status.forEach(s=>{
    if(s.type==="éº»ç—º") atk -= s.level*30;
    if(s.type==="èˆˆå¥®") atk += s.level*30;
  });
  atk=Math.max(0,atk);
  target.currentHp-=atk;
  log(enemy.name+" ã®ã“ã†ã’ãï¼ "+target.name+" ã« "+atk+" ãƒ€ãƒ¡ãƒ¼ã‚¸");
}

drawAllies();

// ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚çŠ¶æ…‹ç•°å¸¸ãƒ€ãƒ¡ãƒ¼ã‚¸ã¨ã‚¿ãƒ¼ãƒ³æ¸›å°‘
applyStatus(enemy);
deck.forEach(c=>applyStatus(c));

if(deck.every(c=>c.currentHp<=0)){ loseBattle(); return; }

turnIndex++;
}

function isStunned(c){ return c.status.some(s=>s.type==="æ‹˜æŸ"); }

function applyStatus(c){
  let remove=[];
  c.status.forEach((s,i)=>{
    if(s.type==="æ¯’"){
      c.currentHp -= s.level*100;
      log(c.name+" ã¯æ¯’ã§ "+s.level*100+" ãƒ€ãƒ¡ãƒ¼ã‚¸");
    }
    s.turn--;
    if(s.turn<=0) remove.push(i);
  });
  remove.reverse().forEach(i=>c.status.splice(i,1));
}

function winBattle(){
 let reward=5;
 coin+=reward;
 stage++;
 if(stage>10){
  battleDiv.classList.add("hidden");
  clearScreen.classList.remove("hidden");
  return;
 }
 log("å‹åˆ© +"+reward+"ã‚³ã‚¤ãƒ³");
 setTimeout(()=>{
  battleDiv.classList.add("hidden");
  shopDiv.classList.remove("hidden");
  refreshShop();
 },1000);
}

function loseBattle(){
 battleDiv.classList.add("hidden");
 gameOverScreen.classList.remove("hidden");
}

function backToTitle(){
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
  stage = 1;
  coin = 6;
  deck = [];
  shop = [];
  enemy = null;
  turnIndex = 0;

  // å‘³æ–¹ã® currentHp ã¨ status ã‚’ãƒªã‚»ãƒƒãƒˆ
  deck.forEach(c=>{
    c.currentHp = c.hp;
    c.status = [];
  });

  // æ•µã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
  if(enemy){
    enemy.hp = 0;
    enemy.status = [];
  }

  // è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
  startDiv.classList.remove("hidden");
  shopDiv.classList.add("hidden");
  battleDiv.classList.add("hidden");
  clearScreen.classList.add("hidden");
  gameOverScreen.classList.add("hidden");

  // ãƒ­ã‚°ãƒªã‚»ãƒƒãƒˆ
  logDiv.innerHTML = "";

  // è¡¨ç¤ºæ›´æ–°
  coinText.innerText = coin;
  stageText.innerText = "Stage " + stage;
  drawDeck();
  shopCards.innerHTML = "";
  sellZone.innerHTML = "";
  enemyArea.innerHTML = "";
  allyArea.innerHTML = "";
}
</script>
</body>
</html>
