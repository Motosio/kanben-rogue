<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Card Rogue</title>
<style>
body{
  background:#111;
  color:white;
  font-family:sans-serif;
  text-align:center;
}
.hidden{display:none;}

.card{
  width:140px;
  height:180px;
  background:black;
  border:3px solid blue;
  border-radius:10px;
  margin:5px;
  padding:5px;
  display:inline-block;
}

.r4{border-color:gold;}
.r5{
 border:3px solid;
 border-image:linear-gradient(45deg,lavender,aqua,white) 1;
}

button{padding:10px;margin:5px;}

#fade{
 position:fixed;
 inset:0;
 background:black;
 opacity:0;
 pointer-events:none;
 transition:0.4s;
}
</style>
</head>
<body>

<div id="fade"></div>
<h2 id="stageText">Stage 1</h2>

<div id="start">
<button onclick="startGame()">スタート</button>
<button>図鑑(未実装)</button>
<button onclick="alert('敵を倒して進むだけです')">チュートリアル</button>
</div>

<div id="shop" class="hidden">
<h3>Coin: <span id="coinText"></span></h3>
<div id="shopCards"></div>
<button onclick="reroll()">更新(1コイン)</button>

<h3>デッキ</h3>
<div id="deck" style="min-height:200px;border:2px dashed gray;padding:10px;"></div>

<h3>売却ゾーン</h3>
<div id="sellZone" style="height:80px;border:2px dashed red;"></div>

<button onclick="battle()">戦闘開始</button>
</div>

<div id="battle" class="hidden">
<div id="enemyArea"></div>
<div id="log"></div>
<button onclick="next()">次へ</button>
</div>

<script>
// ===== データ =====
const baseChars=[
{name:"スウ",atk:300,hp:3000,rarity:3},
{name:"レオナ",atk:400,hp:4000,rarity:4},
{name:"コウ",atk:500,hp:5000,rarity:5},
{name:"キョウ",atk:300,hp:3000,rarity:3},
{name:"カフ",atk:400,hp:4000,rarity:4},
{name:"イグノア",atk:300,hp:3000,rarity:3},
{name:"アレクサンダー",atk:500,hp:5000,rarity:5},
{name:"スフェリコン",atk:400,hp:4000,rarity:4},
{name:"蜜夜",atk:400,hp:4000,rarity:4},
{name:"メビウス",atk:400,hp:4000,rarity:4},
{name:"ローマン",atk:300,hp:3000,rarity:3},
];

let stage=1;
let coin=6;
let deck=[];
let shop=[];

function fade(cb){
 let f=document.getElementById("fade");
 f.style.opacity=1;
 setTimeout(()=>{cb();f.style.opacity=0;},400);
}

function rarityPool(){
 if(stage<=3) return [3];
 if(stage<=6) return [3,4];
 return [3,3,3,3,4,4,4,4,5,5];
}

function cost(r){return r==3?2:r==4?3:4;}
function copyChar(c){return {...c,rank:1,currentHp:c.hp};}

// ===== 開始 =====
function startGame(){
 fade(()=>{
  stage=1;coin=6;deck=[];
  start.classList.add("hidden");
  shopDiv.classList.remove("hidden");
  refreshShop();
 });
}

// ===== ショップ =====
const start=document.getElementById("start");
const shopDiv=document.getElementById("shop");

function refreshShop(){
 stageText.innerText="Stage "+stage;
 coinText.innerText=coin;

 let pool=rarityPool();
 shop=[];
 for(let i=0;i<6;i++){
  let r=pool[Math.floor(Math.random()*pool.length)];
  let list=baseChars.filter(c=>c.rarity==r);
  shop.push(copyChar(list[Math.floor(Math.random()*list.length)]));
 }
 drawShop();
 drawDeck();
}

function drawShop(){
 shopCards.innerHTML="";
 shop.forEach((c)=>{
  let d=document.createElement("div");
  d.className="card r"+c.rarity;
  d.innerHTML=`★${c.rarity}<br>${c.name}<br>⚔️${c.atk}<br>♥${c.hp}<br>${cost(c.rarity)}c`;
  shopCards.appendChild(d);
 });
}

function drawDeck(){
 deck.innerHTML="";
 deck.forEach((c)=>{
  let e=document.createElement("div");
  e.className="card r"+c.rarity;
  e.innerHTML=`R${c.rank}<br>${c.name}<br>⚔️${c.atk}<br>♥${c.hp}`;
  deck.appendChild(e);
 });
}

function buy(i){
 let c=shop[i];
 let p=cost(c.rarity);
 if(coin<p) return;

 let same=deck.find(x=>x.name==c.name);
 if(!same && deck.length>=5) return;

 coin-=p;

 if(same){
  if(same.rank<5){same.rank++;same.atk+=20;same.hp+=20;}
 }else deck.push(copyChar(c));

 refreshShop();
}

function reroll(){if(coin>0){coin--;refreshShop();}}

// ===== 戦闘 =====
function battle(){
 fade(()=>{
  shopDiv.classList.add("hidden");
  battleDiv.classList.remove("hidden");
  runBattle();
 });
}

const battleDiv=document.getElementById("battle");

function runBattle(){
 let log="";
 let boss=(stage==5||stage==10);

 let enemy={name:boss?"ボス":"雑魚",hp:boss?6000:2000,atk:boss?700:500};
 enemyArea.innerHTML=`<div class="card">${enemy.name}<br>⚔️${enemy.atk}<br>♥${enemy.hp}</div>`;

 deck.forEach(c=>c.currentHp=c.hp);

 while(enemy.hp>0 && deck.some(c=>c.currentHp>0)){
  for(let c of deck){
   if(c.currentHp<=0) continue;
   enemy.hp-=c.atk;
   log+=`${c.name}攻撃→${c.atk}<br>`;
   if(enemy.hp<=0) break;
  }
  if(enemy.hp<=0) break;

  if(boss) deck.forEach(c=>c.currentHp-=enemy.atk);
  else for(let i=0;i<3;i++){
   let t=deck[Math.floor(Math.random()*deck.length)];
   t.currentHp-=enemy.atk;
  }
 }

 if(deck.every(c=>c.currentHp<=0)){
  log+="GAME OVER";stage=1;coin=6;deck=[];
 }else{
  log+="勝利<br>";
  let reward=stage<=3?4:stage<=7?6:9;
  coin+=reward;
  log+=`コイン+${reward}<br>`;
  stage++;
 }

 logDiv.innerHTML=log;
}

const logDiv=document.getElementById("log");

function next(){
 fade(()=>{
  battleDiv.classList.add("hidden");
  shopDiv.classList.remove("hidden");
  refreshShop();
 });
}

// ===== 即ドラッグ =====
let dragCard=null,dragIndex=null,fromShop=false;

document.addEventListener("pointerdown",(e)=>{
 let card=e.target.closest(".card");
 if(!card) return;

 dragCard=card.cloneNode(true);
 dragCard.style.position="fixed";
 dragCard.style.pointerEvents="none";
 dragCard.style.opacity=0.7;
 dragCard.style.zIndex=999;
 document.body.appendChild(dragCard);

 moveAt(e);

 let parent=card.parentElement.id;
 if(parent=="shopCards"){
  fromShop=true;
  dragIndex=[...shopCards.children].indexOf(card);
 }else if(parent=="deck"){
  fromShop=false;
  dragIndex=[...deck.children].indexOf(card);
 }
});

document.addEventListener("pointermove",(e)=>{
 if(dragCard) moveAt(e);
});

document.addEventListener("pointerup",(e)=>{
 if(!dragCard) return;

 let deckRect=deck.getBoundingClientRect();
 let sellRect=sellZone.getBoundingClientRect();

 let x=e.clientX,y=e.clientY;

 if(fromShop &&
   x>deckRect.left&&x<deckRect.right&&
   y>deckRect.top&&y<deckRect.bottom){
   buy(dragIndex);
 }

 if(!fromShop &&
   x>sellRect.left&&x<sellRect.right&&
   y>sellRect.top&&y<sellRect.bottom){
   let c=deck[dragIndex];
   coin+=cost(c.rarity);
   deck.splice(dragIndex,1);
   refreshShop();
 }

 dragCard.remove();
 dragCard=null;
});

function moveAt(e){
 dragCard.style.left=e.clientX-70+"px";
 dragCard.style.top=e.clientY-90+"px";
}
</script>
</body>
</html>
