<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Card Rogue</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div id="fade"></div>
<h2 id="stageText">Stage 1</h2>

<div id="start">
<button onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
<button>å›³é‘‘(æœªå®Ÿè£…)</button>
<button onclick="alert('æ•µã‚’å€’ã—ã¦é€²ã‚€ã ã‘ã§ã™')">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</button>
</div>

<div id="shop" class="hidden">
<h3>Coin: <span id="coinText"></span></h3>
<div id="shopCards"></div>
<button onclick="reroll()">æ›´æ–°(1ã‚³ã‚¤ãƒ³)</button>

<h3>ãƒ‡ãƒƒã‚­</h3>
<div id="deck"></div>

<h3>å£²å´ã‚¾ãƒ¼ãƒ³</h3>
<div id="sellZone"></div>

<button onclick="battle()">æˆ¦é—˜é–‹å§‹</button>
</div>

<div id="battle" class="hidden">
<div id="enemyArea"></div>
<div id="log"></div>
<button onclick="next()">æ¬¡ã¸</button>
</div>

<script>
// ===== ãƒ‡ãƒ¼ã‚¿ =====

const baseChars=[
{name:"ã‚¹ã‚¦",atk:300,hp:3000,rarity:3},
{name:"ãƒ¬ã‚ªãƒŠ",atk:400,hp:4000,rarity:4},
{name:"ã‚³ã‚¦",atk:500,hp:5000,rarity:5},
{name:"ã‚­ãƒ§ã‚¦",atk:300,hp:3000,rarity:3},
{name:"ã‚«ãƒ•",atk:400,hp:4000,rarity:4},
{name:"ã‚¤ã‚°ãƒã‚¢",atk:300,hp:3000,rarity:3},
{name:"ã‚¢ãƒ¬ã‚¯ã‚µãƒ³ãƒ€ãƒ¼",atk:500,hp:5000,rarity:5},
{name:"ã‚¹ãƒ•ã‚§ãƒªã‚³ãƒ³",atk:400,hp:4000,rarity:4},
{name:"èœœå¤œ",atk:400,hp:4000,rarity:4},
{name:"ãƒ¡ãƒ“ã‚¦ã‚¹",atk:400,hp:4000,rarity:4},
{name:"ãƒ­ãƒ¼ãƒãƒ³",atk:300,hp:3000,rarity:3},
];

let stage=1;
let coin=6;
let deck=[];
let shop=[];

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====

function cost(r){return r==3?2:r==4?3:4;}
function copyChar(c){return {...c,rank:1,currentHp:c.hp};}

function fade(cb){
 let f=document.getElementById("fade");
 f.style.opacity=1;
 setTimeout(()=>{cb();f.style.opacity=0;},400);
}

function rarityPool(){
 if(stage<=3) return [3];
 if(stage<=6) return [3,4];
 return [3,3,3,3,4,4,4,4,5,5];
}

// ===== é–‹å§‹ =====

function startGame(){
 fade(()=>{
  stage=1;coin=6;deck=[];
  start.classList.add("hidden");
  shopDiv.classList.remove("hidden");
  refreshShop();
 });
}

const start=document.getElementById("start");
const shopDiv=document.getElementById("shop");

// ===== ã‚·ãƒ§ãƒƒãƒ— =====

function refreshShop(){
 stageText.innerText="Stage "+stage;
 coinText.innerText=coin;

 let pool=rarityPool();
 shop=[];
 for(let i=0;i<6;i++){
  let r=pool[Math.floor(Math.random()*pool.length)];
  let list=baseChars.filter(c=>c.rarity==r);
  shop.push(copyChar(list[Math.floor(Math.random()*list.length)]));
 }

 drawShop();
 drawDeck();
}

function drawShop(){
 shopCards.innerHTML="";
 shop.forEach((c,i)=>{
  let d=document.createElement("div");
  d.className="card r"+c.rarity;
  d.draggable=true;

  d.innerHTML=`â˜…${c.rarity}<br>${c.name}<br>âš”ï¸${c.atk}<br>â™¥${c.hp}<br>${cost(c.rarity)}c`;

  d.ondragstart=e=>{
    e.dataTransfer.setData("shopIndex",i);
  };

  shopCards.appendChild(d);
 });
}

function drawDeck(){
 deckDiv.innerHTML="";
 deck.forEach((c,i)=>{
  let d=document.createElement("div");
  d.className="card r"+c.rarity;
  d.draggable=true;

  d.innerHTML=`R${c.rank}<br>${c.name}<br>âš”ï¸${c.atk}<br>â™¥${c.hp}`;

  d.ondragstart=e=>{
    e.dataTransfer.setData("deckIndex",i);
  };

  deckDiv.appendChild(d);
 });
}

const shopCards=document.getElementById("shopCards");
const deckDiv=document.getElementById("deck");
const sellZone=document.getElementById("sellZone");

// ===== ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç† =====

// ã‚·ãƒ§ãƒƒãƒ—â†’ãƒ‡ãƒƒã‚­
deckDiv.ondragover=e=>e.preventDefault();
deckDiv.ondrop=e=>{
 let i=e.dataTransfer.getData("shopIndex");
 if(i==="") return;
 buy(i);
};

// ãƒ‡ãƒƒã‚­â†’å£²å´
sellZone.ondragover=e=>e.preventDefault();
sell.ondrop=(e)=>{
 let idx=e.dataTransfer.getData("index");
 let c=deck[idx];

 coin+=cost(c.rarity);
 deck.splice(idx,1);

 drawDeck();
 document.getElementById("coinText").innerText=coin;
};

// ===== è³¼å…¥ =====

function buy(i){
 let c=shop[i];
 let p=cost(c.rarity);

 if(coin<p) return;

 let same=deck.find(x=>x.name==c.name);

 // é‡è¤‡ã§ãªã„ï¼†5ä½“è¶…ãˆã‚‹ãªã‚‰ç¦æ­¢
 if(!same && deck.length>=5) return;

 // ãƒ©ãƒ³ã‚¯5ã¯è³¼å…¥ä¸å¯
 if(same && same.rank>=5) return;

 // æ”¯æ‰•ã„
 coin-=p;

 if(same){
   same.rank++;
   same.atk+=20;
   same.hp+=20;
 }else{
   deck.push(copyChar(c));
 }

 // â–¼ã“ã“ãŒè¿½åŠ éƒ¨åˆ†
 shop.splice(i,1);   // ã‚·ãƒ§ãƒƒãƒ—ã‹ã‚‰å‰Šé™¤
 drawShop();         // ã‚·ãƒ§ãƒƒãƒ—è¡¨ç¤ºæ›´æ–°

 drawDeck();
 document.getElementById("coinText").innerText=coin;
}
 
function reroll(){
 if(coin<=0) return;
 coin--;
 drawDeck();
 document.getElementById("coinText").innerText=coin;
}

// ===== æˆ¦é—˜ =====

function battle(){
 fade(()=>{
  shopDiv.classList.add("hidden");
  battleDiv.classList.remove("hidden");
  runBattle();
 });
}

const battleDiv=document.getElementById("battle");

function runBattle(){
 let log="";
 let boss=(stage==5||stage==10);

 let enemy={name:boss?"ãƒœã‚¹":"é›‘é­š",hp:boss?6000:2000,atk:boss?700:500};

 enemyArea.innerHTML=`<div class="card">${enemy.name}<br>âš”ï¸${enemy.atk}<br>â™¥${enemy.hp}</div>`;

 deck.forEach(c=>c.currentHp=c.hp);

 while(enemy.hp>0 && deck.some(c=>c.currentHp>0)){
  for(let c of deck){
   if(c.currentHp<=0) continue;
   enemy.hp-=c.atk;
   if(enemy.hp<=0) break;
  }

  if(boss) deck.forEach(c=>c.currentHp-=enemy.atk);
  else{
   for(let i=0;i<3;i++){
    let t=deck[Math.floor(Math.random()*deck.length)];
    t.currentHp-=enemy.atk;
   }
  }
 }

 if(deck.every(c=>c.currentHp<=0)){
  log="GAME OVER";
  stage=1;coin=6;deck=[];
 }else{
  log="å‹åˆ©<br>";

  let reward=stage<=3?4:stage<=7?6:9;
  coin+=reward;
  log+=`ã‚³ã‚¤ãƒ³+${reward}<br>`;

  if(stage>=10){
    log+="ğŸ‰ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ğŸ‰";
    stage=1;coin=6;deck=[];
  }else stage++;
 }

 document.getElementById("log").innerHTML=log;
}

function next(){
 fade(()=>{
  battleDiv.classList.add("hidden");
  shopDiv.classList.remove("hidden");
  refreshShop();
 });
}
</script>

</body>
</html>
